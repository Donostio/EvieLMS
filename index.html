<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rotating URL Display</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        /* Define a common class for both iframes */
        .content-frame {
            border: none;
            width: 100%;
            height: 100%;
            position: absolute; /* Needed for stacking */
            top: 0;
            left: 0;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.5s ease-in-out; /* Smooth fade transition */
        }
        /* Only the active frame is fully visible */
        .active {
            opacity: 1;
            z-index: 10;
        }
    </style>
</head>
<body>
    <!-- Two identically sized iframes for swapping content -->
    <!-- frameA will start as active -->
    <iframe id="frameA" src="about:blank" class="content-frame active"></iframe>
    <!-- frameB will start as the preloader (hidden) -->
    <iframe id="frameB" src="about:blank" class="content-frame"></iframe>

    <script>
        // Array of URLs to rotate, now including a 'type' to distinguish pre-loadable pages
        const urlsToRotate = [
            { url: "https://www.leddepartureboard.com/singleboard/SRC/to/IMW?hideClock=false&hideMenu=true&showStationName=true", duration: 8000, type: 'live' },
            { url: "https://donostio.github.io/EvieForcast/", duration: 5000, type: 'status' }, // Pre-loadable (Weather)
            { url: "https://donostio.github.io/DL-W-PG-status/", duration: 5000, type: 'status' }, // Pre-loadable (Tube Status)
            { url: "https://www.leddepartureboard.com/singleboard/STE/to/WIM?hideClock=false&hideMenu=true&showStationName=true", duration: 8000, type: 'live' }
        ];

        const initialDelay = 2000; // 2 seconds before the first URL from the list is loaded
        const fallbackTimeout = 7000; // Fallback timeout for 'live' pages that don't load quickly

        // currentUrlIndex now ALWAYS points to the page that is ABOUT TO BE DISPLAYED
        let currentUrlIndex = 0; 
        let rotationTimer;
        let loadTimeout;
        
        const frameA = document.getElementById('frameA');
        const frameB = document.getElementById('frameB');
        
        // Initialize frames. We use the 'active' class to track visibility.
        let activeFrame = frameA;
        let preloaderFrame = frameB;
        
        /**
         * Loads a URL into the preloader frame, but only if it's a 'status' page.
         * @param {number} indexToLoad - The index of the URL in urlsToRotate to load next.
         */
        function preloadFrame(indexToLoad) {
            const itemToLoad = urlsToRotate[indexToLoad];
            
            // Only pre-load the GitHub Pages status screens
            if (itemToLoad.type === 'status') {
                preloaderFrame.src = itemToLoad.url;
                console.log(`Pre-loading URL ${indexToLoad} (${itemToLoad.url}) in the background.`);
            } else {
                // Clear the preloader if the next item is a live board (since it loads into the active frame next)
                preloaderFrame.src = 'about:blank';
            }
        }
        
        /**
         * Schedules the next display swap (performRotation) and starts pre-loading the page *after* that.
         * This function is called immediately after a page becomes visible.
         * @param {number} duration - The amount of time (ms) to display the current page.
         */
        function scheduleNextRotation(duration) {
            clearTimeout(rotationTimer);
            
            // 1. Advance the index to the NEXT page to be displayed in the future.
            currentUrlIndex = (currentUrlIndex + 1) % urlsToRotate.length;

            // 2. Preload the page at the newly advanced index (this is the page that will display next).
            preloadFrame(currentUrlIndex); 
            
            // 3. Set the timer for the actual rotation event
            rotationTimer = setTimeout(performRotation, duration);
        }

        /**
         * Handles the actual swap of frames and subsequent loading/pre-loading.
         * currentUrlIndex points to the item we are about to display.
         */
        function performRotation() {
            clearTimeout(loadTimeout);
            
            const nextItem = urlsToRotate[currentUrlIndex];
            
            if (nextItem.type === 'live') {
                // --- LIVE BOARD LOGIC (Must load now, no pre-loading possible) ---
                console.log(`Loading Live URL: ${nextItem.url} for ${nextItem.duration / 1000}s. Index: ${currentUrlIndex}`);
                
                // Load into the current active frame
                activeFrame.src = nextItem.url;
                
                // --- FIX: Add a guard flag to prevent the race condition ---
                let rotationInitiated = false; 

                const finalizeRotation = () => {
                    // If rotation was already initiated by the other event (onload or timeout), exit.
                    if (rotationInitiated) return; 
                    rotationInitiated = true;
                    
                    clearTimeout(loadTimeout); // Clear the timeout
                    activeFrame.onload = null; // Clear the onload handler

                    // Ensure the frame is visible
                    activeFrame.classList.add('active');
                    
                    scheduleNextRotation(nextItem.duration);
                };
                
                activeFrame.onload = finalizeRotation;

                // Fallback timeout for live boards
                loadTimeout = setTimeout(() => {
                    // Check the guard flag before calling finalizeRotation
                    if (!rotationInitiated) {
                        console.warn(`Live board load timeout reached for ${nextItem.url}. Forcing display.`);
                        finalizeRotation(); 
                    }
                }, fallbackTimeout);

            } else {
                // --- STATUS BOARD LOGIC (Pre-loaded, ready for instant swap) ---
                
                // 1. Perform the swap: Hide the current active, show the pre-loaded 
                activeFrame.classList.remove('active');
                preloaderFrame.classList.add('active');
                console.log(`Instantly displaying pre-loaded Status URL: ${nextItem.url}. Index: ${currentUrlIndex}`);

                // 2. Update frame roles for the next cycle
                const tempFrame = activeFrame;
                activeFrame = preloaderFrame;
                preloaderFrame = tempFrame;
                
                // 3. Schedule the next rotation (which advances the index and pre-loads the *following* page)
                scheduleNextRotation(nextItem.duration);
            }
        }

        // Listen for messages from the iframed pages.
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'page-ready') {
                // Find the frame that sent the message
                let frameThatSentMessage = null;
                if (event.source === frameA.contentWindow) {
                    frameThatSentMessage = frameA;
                } else if (event.source === frameB.contentWindow) {
                    frameThatSentMessage = frameB;
                }
                
                if (frameThatSentMessage) {
                    // Check if the signal came from the frame currently acting as the preloader
                    if (frameThatSentMessage === preloaderFrame) {
                        console.log(`Preloader frame confirmed ready for swap: ${preloaderFrame.src}`);
                    } else if (frameThatSentMessage === activeFrame) {
                        console.warn(`Ready signal arrived late from active frame: ${activeFrame.src}.`);
                    }
                }
            }
        });
        
        /**
         * Initial function to start the rotation process.
         */
        function initRotation() {
             // currentUrlIndex is 0. Call performRotation to load the first item.
             performRotation(); 
        }

        // Start the process after the initial delay
        setTimeout(initRotation, initialDelay);
    </script>
</body>
</html>



