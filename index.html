<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Rotating URL Display</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        iframe {
            border: none;
            width: 100%;
            height: 100%;
            display: none; /* Hide by default */
        }
    </style>
</head>
<body>
    <iframe id="contentFrame" src="about:blank"
            allowfullscreen="true"
            mozallowfullscreen="true"
            webkitallowfullscreen="true">
    </iframe>

    <script>
        // Array of URLs to rotate, now including custom durations
        const urlsToRotate = [
            { url: "https://www.leddepartureboard.com/singleboard/SRC/to/IMW?hideClock=false&hideMenu=true&showStationName=true", duration: 8000 },
            { url: "https://donostio.github.io/EvieForcast/", duration: 5000 },
            { url: "https://donostio.github.io/DL-W-PG-status/", duration: 5000 },
            { url: "https://www.leddepartureboard.com/singleboard/STE/to/WIM?hideClock=false&hideMenu=true&showStationName=true", duration: 8000 }
        ];

        const initialDelay = 2000; // 2 seconds before the first URL from the list is loaded
        const fallbackTimeout = 7000; // 7-second fallback timeout for pages that don't signal ready

        let currentUrlIndex = 0;
        const contentFrame = document.getElementById('contentFrame');
        let rotationTimer;
        let loadTimeout;

        // Function to start or continue the rotation
        function startRotation() {
            // Hide the iframe before loading the next page
            contentFrame.style.display = 'none';
            contentFrame.src = 'about:blank'; // Reset iframe source
            
            // Get the current item (URL and its duration) from the array
            const currentItem = urlsToRotate[currentUrlIndex];

            // Load the URL into the iframe
            contentFrame.src = currentItem.url;
            console.log(`Loading URL: ${currentItem.url} for ${currentItem.duration / 1000} seconds.`);

            // Clear any existing timeouts to prevent race conditions
            clearTimeout(loadTimeout);
            clearTimeout(rotationTimer);

            // Check if the current URL is a live departure board
            if (currentItem.url.includes('leddepartureboard.com')) {
                // For live departure boards, assume they don't send a ready signal
                // and use the onload event as the trigger for the main timer.
                contentFrame.onload = () => {
                    contentFrame.style.display = 'block';
                    console.log("Live board detected. Displaying immediately.");
                    scheduleNextRotation(currentItem.duration);
                };
            } else {
                // For all other URLs, use the fallback timeout.
                loadTimeout = setTimeout(() => {
                    console.warn(`Timeout reached for ${currentItem.url}. Forcing next rotation.`);
                    handlePageReady();
                }, fallbackTimeout);
            }
        }
        
        // This function is called when a page is ready or the timeout is reached
        function handlePageReady() {
            // Only proceed if the iframe is not yet visible
            if (contentFrame.style.display !== 'block') {
                clearTimeout(loadTimeout); // Clear the fallback timeout

                contentFrame.style.display = 'block'; // Show the iframe

                const currentItem = urlsToRotate[currentUrlIndex];
                scheduleNextRotation(currentItem.duration);
            }
        }

        // Schedules the next rotation
        function scheduleNextRotation(duration) {
            currentUrlIndex = (currentUrlIndex + 1) % urlsToRotate.length;
            rotationTimer = setTimeout(startRotation, duration);
        }

        // Listen for messages from the iframed pages
        window.addEventListener('message', (event) => {
            // Check if the message is the "page-ready" signal
            if (event.data && event.data.type === 'page-ready') {
                console.log("Received 'page-ready' signal from a child iframe.");
                handlePageReady();
            }
        });

        // Initial delay before the first URL from the list is loaded
        setTimeout(() => {
            startRotation(); // Begin the rotation cycle after the initial delay
        }, initialDelay);
    </script>
</body>
</html>
